const axios = require('axios');

const BASE_URL = 'http://localhost:3000';

// ç­‰å¾…æœåŠ¡å¯åŠ¨
async function waitForService(maxRetries = 30) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      await axios.get(`${BASE_URL}/health`, { timeout: 2000 });
      console.log('âœ… åç«¯æœåŠ¡å·²å¯åŠ¨');
      return true;
    } catch (error) {
      console.log(`â³ ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨... (${i + 1}/${maxRetries})`);
      await new Promise(resolve => setTimeout(resolve, 2000));
    }
  }
  throw new Error('åç«¯æœåŠ¡å¯åŠ¨è¶…æ—¶');
}

// åˆ›å»ºæµ‹è¯•é¡¹ç›®
async function createTestProject() {
  console.log('ğŸ“ åˆ›å»ºæµ‹è¯•é¡¹ç›®...');

  const projectData = {
    bookName: 'æµ‹è¯•å°è¯´ï¼šé¾™ä¸é­”æ³•',
    outline: {
      logline: 'ä¸€ä¸ªå¹´è½»çš„æ³•å¸ˆåœ¨é­”æ³•å¤§é™†ä¸Šå±•å¼€å†’é™©ä¹‹æ—…ï¼Œå¯»æ‰¾å¤±è½çš„é¾™ä¹‹ç§˜å®',
      characters: 'ä¸»è§’ææ˜ï¼šå¹´è½»æ³•å¸ˆï¼Œæœ‰é¾™æ—è¡€ç»Ÿã€‚å¥³ä¸»å°é›¨ï¼šç¥ç§˜çš„é¾™æ—åè£”ã€‚åæ´¾é»‘æš—æ³•å¸ˆï¼šè§Šè§é¾™ä¹‹ç§˜å®',
      world: 'é­”æ³•å¤§é™†åˆ†ä¸ºäººç±»ç‹å›½ã€ç²¾çµæ£®æ—ã€é¾™æ—å±±è„‰ä¸‰å¤§åŒºåŸŸï¼Œå„åŒºåŸŸæœ‰ç‹¬ç‰¹çš„é­”æ³•ä½“ç³»å’Œæ–‡åŒ–',
      hook: 'ææ˜åœ¨ä¸€æ¬¡æ„å¤–ä¸­å‘ç°è‡ªå·±ä½“å†…æµæ·Œç€é¾™æ—çš„è¡€æ¶²ï¼Œè¿™è®©ä»–æˆä¸ºäº†é¾™ä¹‹ç§˜å®çš„å”¯ä¸€ç»§æ‰¿äºº',
      themes: 'è¡€ç»Ÿä¸å‘½è¿ã€å‹‡æ°”ä¸ç‰ºç‰²ã€é­”æ³•ä¸ç§‘æŠ€çš„å†²çª'
    },
    worldSetting: 'åœ¨é­”æ³•å¤§é™†ä¸Šï¼Œé­”æ³•åˆ†ä¸ºå…ƒç´ é­”æ³•ã€ç²¾ç¥é­”æ³•ã€é¾™æ—è¡€è„‰é­”æ³•ä¸‰å¤§ä½“ç³»ã€‚é¾™æ—æ›¾ç»æ˜¯å¤§é™†çš„ç»Ÿæ²»è€…ï¼Œä½†åœ¨ä¸€åœºå¤§æˆ˜åéšå±…å±±è„‰ã€‚äººç±»å»ºç«‹äº†ç‹å›½ï¼Œç²¾çµå®ˆæŠ¤æ£®æ—ã€‚',
    characters: 'ææ˜ï¼š18å²ï¼Œé­”æ³•å­¦é™¢å­¦ç”Ÿï¼Œæ„å¤–è§‰é†’é¾™æ—è¡€ç»Ÿã€‚å°é›¨ï¼šé¾™æ—å…¬ä¸»ï¼ŒåŒ–èº«äººç±»æ¨¡æ ·ç”Ÿæ´»åœ¨ç²¾çµæ£®æ—ã€‚é»‘æš—æ³•å¸ˆï¼šå •è½çš„é¾™æ—åè£”ï¼Œè¿½æ±‚æ°¸æ’ç”Ÿå‘½ã€‚',
    detailedOutline: 'ç¬¬ä¸€å·ï¼šè§‰é†’ç¯‡ã€‚ææ˜å‘ç°é¾™æ—è¡€ç»Ÿ â†’ å­¦ä¹ é¾™æ—é­”æ³• â†’ é‡åˆ°å°é›¨ â†’ é€ƒé¿é»‘æš—æ³•å¸ˆè¿½æ€ã€‚ç¬¬äºŒå·ï¼šå†’é™©ç¯‡ã€‚æ¢ç´¢é¾™æ—å±±è„‰ â†’ å¯»æ‰¾é¾™ä¹‹ç§˜å® â†’ ç»„å»ºåŒç›Ÿ â†’ æœ€ç»ˆå¯¹å†³ã€‚',
    savedMicroStories: [
      {
        title: 'è¡€ç»Ÿè§‰é†’',
        content: 'ææ˜åœ¨é­”æ³•å­¦é™¢çš„æ¯•ä¸šè€ƒè¯•ä¸­æ„å¤–æ¿€æ´»äº†é¾™æ—è¡€ç»Ÿï¼Œé‡Šæ”¾å‡ºå¼ºå¤§çš„é¾™æ¯é­”æ³•ï¼Œéœ‡æƒŠå…¨æ ¡å¸ˆç”Ÿã€‚è¿™è®©ä»–æˆä¸ºäº†å­¦é™¢çš„ç„¦ç‚¹ï¼Œä¹Ÿå¼•èµ·äº†é»‘æš—æ³•å¸ˆçš„æ³¨æ„ã€‚',
        macroStoryTitle: 'é­”æ³•å­¦é™¢ç¯‡',
        order: 0
      },
      {
        title: 'é¾™æ—å…¬ä¸»çš„ç§˜å¯†',
        content: 'å°é›¨åœ¨ç²¾çµæ£®æ—ä¸­ä¸ææ˜ç›¸é‡ï¼Œå¥¹é€éœ²è‡ªå·±æ˜¯é¾™æ—å…¬ä¸»çš„èº«ä»½ï¼Œå¹¶è­¦å‘Šææ˜é¾™ä¹‹ç§˜å®çš„å±é™©æ€§ã€‚ä¸¤äººç»“ä¼´å‰å¾€é¾™æ—å±±è„‰å¯»æ‰¾çº¿ç´¢ã€‚',
        macroStoryTitle: 'ç²¾çµæ£®æ—ç¯‡',
        order: 1
      },
      {
        title: 'é»‘æš—æ³•å¸ˆçš„é˜´è°‹',
        content: 'é»‘æš—æ³•å¸ˆæ´¾å‡ºä¼—å¤šæ‰‹ä¸‹è¿½æ€ææ˜ï¼Œè¯•å›¾å¤ºå–ä»–çš„é¾™æ—è¡€ç»Ÿã€‚åœ¨ä¸€åœºæ¿€æˆ˜ä¸­ï¼Œææ˜å’Œå°é›¨è¢«è¿«é€ƒå…¥é¾™æ—ç¦åœ°ï¼Œæ„å¤–å‘ç°äº†é¾™ä¹‹ç§˜å®çš„çº¿ç´¢ã€‚',
        macroStoryTitle: 'è¿½æ€ç¯‡',
        order: 2
      },
      {
        title: 'é¾™æ—å±±è„‰çš„è€ƒéªŒ',
        content: 'ææ˜å’Œå°é›¨è¿›å…¥é¾™æ—å±±è„‰ï¼Œé€šè¿‡é‡é‡è€ƒéªŒï¼Œç»ˆäºæ‰¾åˆ°äº†é¾™ä¹‹ç§˜å®ã€‚ä½†ä»–ä»¬å‘ç°è¿™ä»¶å®ç‰©è•´å«ç€å·¨å¤§çš„åŠ›é‡ï¼Œå¯èƒ½æ¯ç­æ•´ä¸ªå¤§é™†ã€‚',
        macroStoryTitle: 'é¾™æ—å±±è„‰ç¯‡',
        order: 3
      },
      {
        title: 'æœ€ç»ˆå¯¹å†³',
        content: 'é»‘æš—æ³•å¸ˆç‡é¢†å¤§å†›æ”»å…¥é¾™æ—å±±è„‰ï¼Œææ˜ä¸å¾—ä¸é¢å¯¹è‡ªå·±çš„å‘½è¿æŠ‰æ‹©ã€‚æ˜¯ä½¿ç”¨é¾™ä¹‹ç§˜å®çš„åŠ›é‡æ‹¯æ•‘å¤§é™†ï¼Œè¿˜æ˜¯å°†å…¶æ°¸è¿œå°å°ï¼Ÿ',
        macroStoryTitle: 'ç»ˆç« ç¯‡',
        order: 4
      },
      {
        title: 'æ–°çš„å¼€å§‹',
        content: 'å‡»è´¥é»‘æš—æ³•å¸ˆåï¼Œææ˜å’Œå°é›¨å¼€å§‹é‡å»ºé¾™æ—ä¸äººç±»çš„å’Œå¹³å…³ç³»ã€‚ææ˜æˆä¸ºäº†æ–°çš„é¾™æ—å®ˆæŠ¤è€…ï¼Œå¼€å¯äº†é­”æ³•å¤§é™†çš„æ–°çºªå…ƒã€‚',
        macroStoryTitle: 'ç»“å±€ç¯‡',
        order: 5
      }
    ]
  };

  const response = await axios.post(`${BASE_URL}/projects`, projectData, {
    headers: { 'Content-Type': 'application/json' }
  });

  console.log('âœ… æµ‹è¯•é¡¹ç›®åˆ›å»ºæˆåŠŸï¼Œé¡¹ç›®ID:', response.data.id);
  return response.data.id;
}

// æµ‹è¯•ä¸€é”®å¾ªç¯ç”Ÿæˆ
async function testCycleGeneration(projectId) {
  console.log('ğŸ”„ å¼€å§‹æµ‹è¯•ä¸€é”®å¾ªç¯ç”Ÿæˆ...');

  try {
    const response = await axios.post(`${BASE_URL}/blueprint/generate-full-cycle`, {
      projectId: projectId
    }, {
      timeout: 300000, // 5åˆ†é’Ÿè¶…æ—¶
      headers: { 'Content-Type': 'application/json' }
    });

    console.log('âœ… ä¸€é”®å¾ªç¯ç”Ÿæˆå®Œæˆ!');
    console.log('ğŸ“Š ç”Ÿæˆç»“æœ:', response.data);

  } catch (error) {
    console.error('âŒ ä¸€é”®å¾ªç¯ç”Ÿæˆå¤±è´¥:', error.response?.data || error.message);
  }
}

// ä¸»æµ‹è¯•å‡½æ•°
async function runTest() {
  try {
    console.log('ğŸš€ å¼€å§‹æµ‹è¯•æ•…äº‹æ¶æ„å¸ˆä¸€é”®å¾ªç¯ç”ŸæˆåŠŸèƒ½\n');

    // ç­‰å¾…æœåŠ¡å¯åŠ¨
    await waitForService();

    // åˆ›å»ºæµ‹è¯•é¡¹ç›®
    const projectId = await createTestProject();

    // ç­‰å¾…ä¸€ä¸‹è®©æ•°æ®ä¿å­˜
    await new Promise(resolve => setTimeout(resolve, 2000));

    // æµ‹è¯•ä¸€é”®å¾ªç¯ç”Ÿæˆ
    await testCycleGeneration(projectId);

    console.log('\nğŸ‰ æµ‹è¯•å®Œæˆï¼');

  } catch (error) {
    console.error('âŒ æµ‹è¯•å¤±è´¥:', error.message);
    process.exit(1);
  }
}

runTest();